# Import necessary libraries
import pandas as pd
import joblib
from flask import Flask, request, jsonify
import os

# Create a Flask web server
app = Flask(__name__)

# Construct the full path to the model file
# This is a more robust way to handle file paths in different environments
model_path = os.path.join(os.getcwd(), 'insurance_rf_model.pkl')

# Load the trained model at startup to avoid reloading it on every request
try:
    model = joblib.load(model_path)
    print(f"Model loaded successfully from: {model_path}")
except FileNotFoundError:
    print(f"Error: 'insurance_rf_model.pkl' not found at '{model_path}'. Make sure the model file is in the same directory.")
    model = None
except Exception as e:
    print(f"An unexpected error occurred while loading the model: {e}")
    model = None

@app.route('/predict', methods=['POST'])
def predict():
    """
    Handles POST requests to the /predict endpoint.
    It expects a JSON payload with user data, uses the loaded model to predict the premium,
    and returns the prediction as a JSON response.
    """
    if not model:
        return jsonify({'error': 'Model not loaded.'}), 500

    # Get the JSON data from the request
    data = request.get_json()

    # Ensure all necessary fields are present
    required_fields = ['age', 'sex', 'bmi', 'children', 'smoker', 'region']
    if not all(field in data for field in required_fields):
        return jsonify({'error': 'Missing required fields in request.'}), 400

    try:
        # Create a pandas DataFrame from the input data to match the training data format
        user_df = pd.DataFrame([data])
        
        # Make a prediction using the loaded model
        prediction = model.predict(user_df)[0]
        
        # Return the prediction as a JSON response
        return jsonify({'premium': round(prediction, 2)})
    except Exception as e:
        # Handle any potential errors during prediction
        return jsonify({'error': str(e)}), 500
